<section>
  <div class="container pull-right" id="chatbox">
    <div class="row chat-window col-xs-5 col-md-3 pull-right" id="chat_window_1">
      <div class="col-xs-12 col-md-12">
        <div class="panel panel-default">
          <div class="panel-heading top-bar">
            <div class="row">
              <div class="col-md-8 col-xs-8">
                <h3 class="panel-title" style="font-size: 12px;">
                  <span class="fas fa-comments glyphicon glyphicon-comment"></span> Chat Window
                </h3>
              </div>
              <div class="col-md-4 col-xs-4" style="text-align: right; float: right;">
                <a href="javascript:;">
                  <span id="minim_chat_window" class="fas fa-window-minimize glyphicon glyphicon-minus icon_minim"></span>
                </a>
                <a href="javascript:;">
                  <span class="fas fa-times glyphicon glyphicon-remove icon_close" data-id="chat_window_1"></span>
                </a>
              </div>
            </div>
          </div>
          <div id="messagebody" class="panel-body msg_container_base">
            {{#each talkThreads.talk}}

                {{#ifCond this.from_id "==" ../LoggedInUser.id}}
                <div class="row msg_container base_sent">
                  <div class="col-md-10 col-xs-10">
                    <div class="messages msg_sent">
                      <p>{{this.message}}</p>
                      <time datetime="2009-11-13T20:00">{{this.created_on}}</time>
                    </div>
                  </div>
                </div>
                {{else ifCond this.from_id "!=" ../LoggedInUser.id}}
                  <div class="row msg_container base_receive">
                   
                    <div class="col-md-10 col-xs-10">
                      <div class="messages msg_receive">
                        <p>{{this.message}}</p>
                        <time datetime="2009-11-13T20:00">{{this.created_on}}</time>
                      </div>
                    </div>
                  </div>

                {{/ifCond}}
            {{/each}}


           {{!--  <div class="row msg_container base_receive">
              <div class="col-md-2 col-xs-2 avatar">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Rajesh_Gopinathan.jpg/220px-Rajesh_Gopinathan.jpg" class="chatimg img-responsive ">
              </div>
              <div class="col-md-10 col-xs-10">
                <div class="messages msg_receive">
                  <p>Hi sir,</p>
                  <time datetime="2009-11-13T20:00">Rajesh M • Yesterday 10:05:28</time>
                </div>
              </div>
            </div>


            <div class="row msg_container base_receive">
              <div class="col-md-2 col-xs-2 avatar">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Rajesh_Gopinathan.jpg/220px-Rajesh_Gopinathan.jpg" class="chatimg img-responsive ">
              </div>
              <div class="col-xs-10 col-md-10">
                <div class="messages msg_receive">
                  <p>How are you?</p>
                  <time datetime="2009-11-13T20:00">Rajesh M • Yesterday 10:05:33</time>
                </div>
              </div>
            </div>

            <div class="row msg_container base_sent">
              <div class="col-xs-10 col-md-10">
                <div class="messages msg_sent">
                  <p>I am Fine. Hw about u?</p>
                  <time datetime="2009-11-13T20:00">Administrator • Yesterday 10:05:38</time>
                </div>
              </div>
              <div class="col-md-2 col-xs-2 avatar">
                <img src="https://cheme.mit.edu/wp-content/uploads/2017/01/stephanopoulosgeorge-431x400.jpg" class="chatimg img-responsive ">
              </div>
            </div>

            <div class="row msg_container base_receive">
              <div class="col-md-2 col-xs-2 avatar">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Rajesh_Gopinathan.jpg/220px-Rajesh_Gopinathan.jpg" class="chatimg img-responsive ">
              </div>
              <div class="col-xs-10 col-md-10">
                <div class="messages msg_receive">
                  <p>I am also doing fine. See you later sir.</p>
                  <time datetime="2009-11-13T20:00">Rajesh M • Yesterday 10:05:41</time>
                </div>
              </div>
            </div>

            <div class="row msg_container base_sent">
              <div class="col-md-10 col-xs-10 ">
                <div class="messages msg_sent">
                  <p>Good, Have a nice day.</p>
                  <time datetime="2009-11-13T20:00">Administrator • Yesterday 10:05:45</time>
                </div>
              </div>
              <div class="col-md-2 col-xs-2 avatar">
                <img src="https://cheme.mit.edu/wp-content/uploads/2017/01/stephanopoulosgeorge-431x400.jpg" class="chatimg img-responsive ">
              </div>
            </div> --}}


         

        </div>
        <div class="panel-footer panel-body">
          <div class="input-group">
            <input id="btn-input" type="text" class="form-control input-sm chat_input" placeholder="Write your message here..." required="required"
            />
            <span class="input-group-btn">
              <button class="btn btn-primary btn-sm" id="btn-chat">Send</button>
            </span>
          </div>
        </div>
      </div>
    </div>


   {{!--  <div class="btn-group dropup">
      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
        <span class="glyphicon glyphicon-cog"></span>
        <span class="sr-only">Toggle Dropdown</span>
      </button>
      <ul class="dropdown-menu" role="menu">
        <li>
          <a href="#" id="new_chat">
            <span class="glyphicon glyphicon-plus"></span> Novo</a>
        </li>
        <li>
          <a href="#">
            <span class="glyphicon glyphicon-list"></span> Ver outras</a>
        </li>
        <li>
          <a href="#">
            <span class="glyphicon glyphicon-remove"></span> Fechar Tudo</a>
        </li>
        <li class="divider"></li>
        <li>
          <a href="#">
            <span class="glyphicon glyphicon-eye-close"></span> Invisivel</a>
        </li>
      </ul>
    </div>
  </div>
 --}}


</section>


<script>
  $(function(){
    if({{{ DisplayJSON LoggedInUser.id }}} != null){
      var socketChat = {
        "id": {{{ DisplayJSON talkThreads.threadId }}},
        "user": {{{ DisplayJSON LoggedInUser.id }}}
      }
      console.log("socketChat", socketChat);
      var socket = io();
      console.log("socket", socket);
      socket.emit('chat:join', socketChat);
    }
    
    socket.on('chat:receive', function(data){
     var dt = new Date();
     var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();
      console.log("data", data);
      var base;
      console.log("socketChat.user", socketChat.user);
      if(data.from_id == socketChat.user) {
            base = "base_sent"
            console.log("base sent", base);
      } else {
            base = "base_receive"
            console.log("base receive", base);
      } 
      var body = '<div class="row msg_container '+base+'">' +
        '<div class="col-md-10 col-xs-10 ">' +
        '<div class="messages msg_sent">' +
        '<p>' + data.message + '</p>' +
        ' <time datetime="2009-11-13T20:00">Administrator • Today ' + time + '</time>' +
        '</div>' +
        '</div>' +
        '</div>';
      $(body).appendTo("#messagebody");
      //$('#btn-input').val('');
      $("#messagebody").animate({
        scrollTop: $("#messagebody")[0].scrollHeight
      }, 'slow');
    }) 
    
    
  })
  
  $(document).on('click', '.panel-heading span.icon_minim', function (e) {
    var $this = $(this);
    if (!$this.hasClass('panel-collapsed')) {
      $this.parents('.panel').find('.panel-body').slideUp();
      $this.addClass('panel-collapsed');
      $this.removeClass('glyphicon-minus').addClass('glyphicon-plus');
    } else {
      $this.parents('.panel').find('.panel-body').slideDown();
      $this.removeClass('panel-collapsed');
      $this.removeClass('glyphicon-plus').addClass('glyphicon-minus');
    }
  });
  $(document).on('focus', '.panel-footer input.chat_input', function (e) {
    var $this = $(this);
    if ($('#minim_chat_window').hasClass('panel-collapsed')) {
      $this.parents('.panel').find('.panel-body').slideDown();
      $('#minim_chat_window').removeClass('panel-collapsed');
      $('#minim_chat_window').removeClass('glyphicon-plus').addClass('glyphicon-minus');
    }
  });
  $(document).on('click', '#new_chat', function (e) {
    var size = $(".chat-window:last-child").css("margin-left");
    size_total = parseInt(size) + 400;
    alert(size_total);
    var clone = $("#chat_window_1").clone().appendTo(".container");
    clone.css("margin-left", size_total);
  });
  $(document).on('click', '.icon_close', function (e) {
    //$(this).parent().parent().parent().parent().remove();
    $("#chatbox").hide();
  });

  // send function start

  function send() {
    var chat = $("#btn-input").val();

    var dt = new Date();
    var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();

    if (chat == "") {
      alert('Enter Message');
    } else {
      var socket = io();
      var sendSocket = {
        'from_id': {{{ DisplayJSON LoggedInUser.id }}},
        'talk_thread_id': {{{ DisplayJSON talkThreads.threadId }}},
        'message': chat
      }
      socket.emit('chat:send', sendSocket);
       $('#btn-input').val('');
      /*var body = '<div class="row msg_container base_sent">' +
        '<div class="col-md-10 col-xs-10 ">' +
        '<div class="messages msg_sent">' +
        '<p>' + chat + '</p>' +
        ' <time datetime="2009-11-13T20:00">Administrator • Today ' + time + '</time>' +
        '</div>' +
        '</div>' +
        '<div class="col-md-2 col-xs-2 avatar">' +
        '<img class="chatimg" src="https://cheme.mit.edu/wp-content/uploads/2017/01/stephanopoulosgeorge-431x400.jpg" class=" img-responsive ">' +
        '</div>' +
        '</div>';
    }
    $(body).appendTo("#messagebody");
    $('#btn-input').val('');
    $("#messagebody").animate({
      scrollTop: $("#messagebody")[0].scrollHeight
    }, 'slow');*/
  }}


  // send function end




  $("#btn-chat").click(function () {
    send()
  });

  $('#btn-input').keypress(function (e) {
    if (e.which == 13) {
      send()
    }
  });

</script>

<style>
  .chat-window {
    bottom: 0;
    right: 0;
    position: fixed;
    float: right;

  }

  .chat-window>div>.panel {
    border-radius: 5px 5px 0 0;
  }

  .icon_minim {
    padding: 2px 10px;
  }

  .msg_container_base {
    background: #e5e5e5;
    margin: 0;
    padding: 0 10px 10px;
    max-height: 300px;
    overflow-x: hidden;
  }

  .top-bar {
    background: #666;
    color: white;
    padding: 10px;
    position: relative;
    overflow: hidden;
  }

  .msg_receive {
    padding-left: 0;
    margin-left: 0;
  }

  .msg_sent {
    padding-bottom: 20px !important;
    margin-right: 0;
  }

  .messages {
    background: white;
    padding: 10px;
    border-radius: 2px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    max-width: 100%;
  }

  .messages>p {
    font-size: 13px;
    margin: 0 0 0.2rem 0;
  }

  .messages>time {
    font-size: 11px;
    color: #ccc;
  }

  .msg_container {
    padding: 10px;
    overflow: hidden;
    display: flex;
  }

  .chatimg {
    display: block;
    width: 100%;
  }

  .avatar {
    position: relative;
  }

  .base_receive>.avatar:after {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border: 5px solid #FFF;
    border-left-color: rgba(0, 0, 0, 0);
    border-bottom-color: rgba(0, 0, 0, 0);
  }

  .base_sent {
    justify-content: flex-end;
    align-items: flex-end;
  }

  .base_sent>.avatar:after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 0;
    border: 5px solid white;
    border-right-color: transparent;
    border-top-color: transparent;
    box-shadow: 1px 1px 2px rgba(black, 0.2); // not quite perfect but close
  }

  .msg_sent>time {
    float: right;
  }



  .msg_container_base::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
    background-color: #F5F5F5;
  }

  .msg_container_base::-webkit-scrollbar {
    width: 12px;
    background-color: #F5F5F5;
  }

  .msg_container_base::-webkit-scrollbar-thumb {
    -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, .3);
    background-color: #555;
  }

  .btn-group.dropup {
    position: fixed;
    left: 0px;
    bottom: 0;
  }

  .panel-footer {
    padding: 10px 15px;
    background-color: #ccace0;
    border-top: 1px solid #ddd;
    border-bottom-right-radius: 3px;
    border-bottom-left-radius: 3px;


  }

</style>
