<script>

function decodeAddress(geodetail){
	
	var address_components = geodetail.address_components;
	
    for (var i=0; i<address_components.length; i++)
    {
        if (address_components[i].types[0] == "locality") {
                //this is the object you are looking for
                city = address_components[i];
        }
        
		if (address_components[i].types[0] == "administrative_area_level_1") {
                //this is the object you are looking for
                region = address_components[i];
        }
        
		if (address_components[i].types[0] == "country") {
                //this is the object you are looking for
                country = address_components[i];
        }
    }

	var geoaddress = {};
	geoaddress.city = city.long_name;
	geoaddress.region = region.long_name;
	geoaddress.country = country.long_name;
	geoaddress.formatted_address = geodetail.formatted_address;
	
	return geoaddress;
}

function getGeoAddress(results) {

      //console.log(results);
        if (results[1]) {
	        var indice=0;
	        for (var j=0; j<results.length; j++){
	            if (results[j].types[0]=='locality')
	                {
	                    indice=j;
	                    break;
	                }
	        }
			
			return decodeAddress(results[j])
	
        } else {
          console.log("No geo address found");
        }
 }

    var userConfig = {};
    var geocoder = new google.maps.Geocoder;

    var determineUserLocation = function(callback) {

        userConfig = JSON.parse(localStorage.getItem('UserConfig'))

        if (userConfig && userConfig.location) {
            callback(userConfig);
        } else {
            if (navigator.geolocation) {
				userConfig = {};
                navigator.geolocation.getCurrentPosition(function (position) {
                    geoSearchNearLng = position.coords.longitude;
                    geoSearchNearLat = position.coords.latitude;

                    userConfig.location = {
                        geoSearchNearLng: geoSearchNearLng,
                        geoSearchNearLat: geoSearchNearLat
                    };

                    var latlng = {lat: parseFloat(geoSearchNearLat), lng: parseFloat(geoSearchNearLng)};

                    geocoder.geocode({'location': latlng}, function (results, status) {
                        if (status === google.maps.GeocoderStatus.OK) {
                            userConfig.geoInfo = getGeoAddress(results);;
                        }

                        localStorage.setItem('UserConfig', JSON.stringify(userConfig));
                        callback(userConfig);
                    });


                }, function (error) {
					// Default location
                    userConfig.location = {
                        geoSearchNearLng: -100.655093,
                        geoSearchNearLat: 41.3884206
                    };
						
					var geoaddress = {};
					geoaddress.city = "All Cities";
					geoaddress.region = "All States";
					geoaddress.country = "USA";
					geoaddress.formatted_address = "USA";
					
					userConfig.geoInfo = geoaddress;
                    localStorage.setItem('UserConfig', JSON.stringify(userConfig));
                    callback(userConfig);
					
                    console.log('Location access denied' + error.code);
                }, {
                    maximumAge: 5 * 60 * 1000
                });
            } else {
                callback(userConfig);
                console.log("Cannot determine user location");
            }
        }
    };

</script>